### Summary and Integration of Coinbase Onramp & Offramp for CryptoEats

Jacque, since Coinbase Commerce is your core for crypto payments (handling charges, webhooks, and integrations with your Base chain escrow), adding Onramp (fiat-to-crypto) and Offramp (crypto-to-fiat) from Coinbase Developer Platform (CDP) is a natural extension. This creates a seamless loop: Users buy crypto with fiat (Onramp), pay for deliveries in USDC (Commerce), and cash out earnings (Offramp)â€”all without leaving your app. It's perfect for your Miami users (high crypto adoption) and diversifies beyond Stripe/Adyen/GoDaddy for fiat.

I reviewed the provided docs (welcome intro and Offramp APIs overview). Here's a breakdown, key features, and how to integrate into your PaymentRouter class (building on our multi-provider code). This keeps control in-houseâ€”Coinbase handles the heavy lifting, but you route based on order type.

#### 1. **Coinbase Onramp & Offramp Introduction (From First Link)**
   - **Overview:** CDP's Onramp and Offramp enable easy fiat-crypto conversions in apps. Onramp lets users buy crypto with fiat (cards/bank); Offramp lets them sell crypto for fiat (direct to bank). Designed for developers to embed in non-custodial wallets/apps like yoursâ€”supports KYC, compliance, and low fees.
   - **Key Features:**
     - **Onramp (Fiat-to-Crypto):** Buy 100+ assets (USDC, ETH, BTC) with cards/bank transfers/Apple Pay. Prefunded for instant delivery; global (150+ countries, 50+ fiat currencies).
     - **Offramp (Crypto-to-Fiat):** Sell crypto (USDC first, more coming) to bank accounts. Instant in select regions; supports US/EU/UK.
     - **Benefits:** 1-2% fees (lower than exchanges); 99% approval rates; built-in fraud/KYC (complies with FL regs for alcohol/delivery); API/web SDKs for easy embed (no redirects).
     - **How It Works:** 
       - Onramp: User selects asset/amount; CDP handles payment/KYC; delivers crypto to wallet.
       - Offramp: User selects crypto/amount; CDP sells and sends fiat to bank (1-3 days ACH, instant SEPA).
     - **Supported Assets:** Onramp: 100+ cryptos (USDC priority for you); Offramp: USDC (expand to ETH/BTC soon).
     - **Integration Options:** REST APIs, Web SDK (embed in app), Mobile SDK (Expo-compatible). Sandbox for testing; webhooks for updates.
     - **Fit for CryptoEats:** Enable "Buy USDC" in checkout (for low-balance users) or "Cash Out Earnings" for driversâ€”boosts adoption without full exchange license.

#### 2. **Offramp APIs Overview (From Second Link)**
   - **Overview:** Offramp APIs let apps initiate crypto-to-fiat sales. Async flow: Quote â†’ Order â†’ Payout. Focuses on USDC to USD (bank transfers); expands to more assets/fiat.
   - **Key Features:** 
     - **Endpoints:** 
       - GET /quotes: Get sell quotes (amount, fees, rates).
       - POST /orders: Create sell order (crypto to fiat).
       - GET /orders/{id}: Track status (pending, processing, complete).
       - Webhooks: For updates (e.g., order.complete).
     - **Authentication:** API keys (Bearer token); OAuth for advanced.
     - **Integration Steps:** 
       1. Authenticate with key.
       2. Get quote (user selects amount/asset).
       3. Create order (user confirms; CDP handles KYC if needed).
       4. Poll/webhook for status; payout to bank.
     - **Supported Assets:** USDC (on Base/Eth); fiat: USD (ACH/SEPA).
     - **Error Handling:** Standard HTTP codes (400 bad request, 401 unauth); retry on 5xx; webhooks for async failures.
     - **Best Practices:** Use quotes for real-time pricing; handle KYC prompts; log for compliance (your Sentry fits); test in sandbox (free).
     - **Fit for CryptoEats:** Drivers cash out USDC earnings to bank (instant in US)â€”ties into your payout flow. Low fees (1-2%) vs. exchanges.

#### **Integration into CryptoEats PaymentRouter**
Your multi-provider setup is idealâ€”add Coinbase as 'offramp' type for sells. Code below extends our router: Create quotes/orders for Onramp/Offramp; refunds via manual sends (crypto irreversible, but log/reverse via escrow if needed); disputes via webhooks (notify admin for arbitration per ToS).

```typescript
// payments.router.ts (Updated with Coinbase Onramp/Offramp)
import Stripe from 'stripe';
import * as Adyen from '@adyen/adyen-node-api-library';
import { Square } from 'square';
import axios from 'axios';
import Client from '@coinbase/coinbase-commerce-node'; // For Commerce; use CDP SDK for Onramp/Offramp (npm install @coinbase/cdp-sdk)

interface Order {
  id: string;
  amount: number;
  currency: string;
  isInternational: boolean;
  type: 'online' | 'in-person' | 'pos' | 'crypto' | 'onramp' | 'offramp'; // Added onramp/offramp
  customerWallet?: string; // For crypto/onramp
  bankAccount?: string; // For offramp
  // Add more
}

// Provider interfaces
interface PaymentProvider {
  createPayment(order: Order): Promise<{ clientSecret?: string; intentId: string; txHash?: string }>;
  capturePayment(intentId: string, orderId: string): Promise<{ success: boolean }>;
  refundPayment(intentId: string, amount: number, reason?: string): Promise<{ success: boolean; refundId: string }>;
  handleDispute(webhookData: any): Promise<{ resolution: string }>;
}

// ... (Stripe, Adyen, GoDaddy, Square classes same as before)

// Coinbase Provider (Updated for Onramp/Offramp)
class CoinbaseProvider implements PaymentProvider {
  private client: typeof Client;
  private cdpClient; // Assume CDP SDK: import CDP from '@coinbase/cdp-sdk';

  constructor() {
    Client.setApiKey(process.env.COINBASE_API_KEY);
    this.client = Client;
    this.cdpClient = new CDP({ apiKey: process.env.COINBASE_CDP_KEY }); // For Onramp/Offramp
  }

  async createPayment(order: Order): Promise<{ intentId: string }> {
    if (order.type === 'crypto') {
      const charge = new this.client.ChargeResource();
      const response = await charge.create({
        name: 'CryptoEats Order',
        description: `Order #${order.id}`,
        pricing_type: 'fixed_price',
        local_price: { amount: order.amount.toString(), currency: order.currency },
        metadata: { orderId: order.id },
      });
      return { intentId: response.id };
    } else if (order.type === 'onramp') {
      // Onramp: Create buy session
      const response = await this.cdpClient.onramp.createSession({
        amount: order.amount,
        currency: order.currency,
        wallet: order.customerWallet,
      });
      return { intentId: response.sessionId };
    } else if (order.type === 'offramp') {
      // Offramp: Create sell order
      const quote = await this.cdpClient.offramp.getQuote({ amount: order.amount, currency: 'USDC' });
      const response = await this.cdpClient.offramp.createOrder({
        quoteId: quote.id,
        bankAccount: order.bankAccount,
      });
      return { intentId: response.orderId };
    }
    throw new Error('Invalid order type for Coinbase');
  }

  async capturePayment(intentId: string): Promise<{ success: boolean }> {
    // Commerce/Onramp: Instant, no capture. Offramp: Confirm if needed
    return { success: true };
  }

  async refundPayment(intentId: string, amount: number, reason?: string): Promise<{ success: boolean; refundId: string }> {
    // Commerce refunds manual; for Onramp/Offramp, reverse if possible
    const charge = await new this.client.ChargeResource().retrieve(intentId);
    // Manual send back (use wallet or CDP for offramp reverse)
    console.log(`Refund ${amount} to wallet/bank for ${intentId}: ${reason}`);
    return { success: true, refundId: `refund_${intentId}` };
  }

  async handleDispute(webhookData: any): Promise<{ resolution: string }> {
    if (webhookData.type === 'charge:failed' || webhookData.event === 'dispute:created') {
      console.log('Dispute:', webhookData.data.id);
      // Notify admin; resolve via Coinbase portal/arbitration
      return { resolution: 'admin_review_required' };
    }
    return { resolution: 'no_action' };
  }
}

// Payment Router (Same as before, routes 'onramp'/'offramp' to Coinbase)

// Usage: Same, plus new endpoints if needed for onramp/offramp quotes

// Example: Offramp Endpoint (for driver cashout)
export const createOfframp = async (req: Request, res: Response) => {
  const order: Order = { ...req.body, type: 'offramp' };
  try {
    const result = await router.createPayment(order);
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};
```

This adds Onramp/Offramp to Coinbase providerâ€”create sessions/orders; refunds manual (log/send); disputes logged for resolution (e.g., email admin for arbitration per ToS). Use CDP SDK for APIs (npm install @coinbase/cdp-sdk). Test with sandbox keys! For full webhook setup, add Coinbase signature verification. Let's iterate if needed. ðŸš€