# CryptoEats - Food & Alcohol Delivery Platform with Automated Tax Engine, Human-First Driver Policy, Legal Compliance, Blockchain Integration (Phases 1 & 2), and Coinbase Onramp (Phase 3)

Build a complete, full-featured three-part food and alcohol delivery system consisting of a Customer App, Driver App, and Backend API. Implement Phases 1 (core delivery), 2 (smart contracts for NFT and escrow), and now Phase 3 (Coinbase Onramp for in-app crypto purchases) to create a beyond-MVP product ready for production. Include all specified features, such as advanced AI, payment integrations, compliance tools, analytics, automated tax engine for Florida (Miami-Dade) 2026, "Human-First Performance" policy, legal compliance (SB 676, insurance, agreements), and blockchain elements using Base contracts:

- **MarketplaceNFT Contract**: 0x21Fb1fFaefA40c042276BB4Bcf8B826A647aE91E (mint NFTs for rewards)
- **MarketplaceEscrow Contract**: 0x7e1868430e86304Aac93a8964c4a1D5C12A76ED5 (escrow payments)

For Phase 3: Integrate Coinbase Onramp using the provided demo repos (mobile: https://github.com/coinbase/onramp-v2-mobile-demo, web: https://github.com/coinbase/onramp-demo-application). Add embedded wallets (auto-created on signup), Apple Pay/Google Pay support, gasless USDC transfers on Base, push notifications for transactions, and fiat-to-crypto onramp flows. Users can buy USDC directly in-app for payments, with seamless integration to escrow and NFT minting.

Use ethers.js/WalletConnect for blockchain, Expo for React Native (mobile compatibility), and Base RPC. Prepare for off-ramp in future expansions.

## Core Architecture

**Tech Stack:**
- Backend: Node.js with Express
- Database: PostgreSQL with Prisma ORM
- Real-time: Socket.io for live tracking and chat
- Customer App: React Native with Expo (mobile-ready)
- Driver App: React Native with Expo
- Authentication: JWT tokens
- File Storage: AWS S3 or Firebase for documents/images
- Additional: Redis (caching), BullMQ (jobs), ethers.js (contracts), WalletConnect (wallets), Expo Notifications (push)
- Tax: TaxJar API, Florida DOR integration
- Legal: DocuSign/pdf-lib for agreements
- Blockchain: Base RPC (https://mainnet.base.org), USDC (0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913)
- Onramp: Coinbase Onramp SDK (embedded wallets, Apple Pay, gasless on Base)

## Phase 1: Core Features (Delivery Base)
- As previously defined: Apps, API, payments (Stripe/Coinbase Commerce), AI, tax, policy, compliance

## Phase 2: Blockchain (NFT/Escrow)
- Wallet connection via WalletConnect
- Escrow: Deposit on order, release on completion
- NFT: Mint on milestones (e.g., deliveries/orders), trade in marketplace tab

## Phase 3: Coinbase Onramp (Fiat-to-Crypto)
- Embedded Wallets: Auto-create on signup (ERC-4337 smart accounts)
- Onramp Flow: "Buy Crypto" button opens Onramp UI; support cards/Apple Pay/Google Pay/PayPal; buy USDC on Base
- Integration: Use Onramp SDK in React Native (Expo-compatible); handle callbacks for wallet funding
- Gasless: Enable Paymaster for free USDC transfers/escrow deposits
- Push Notifications: Expo for transaction updates (e.g., "USDC purchased", "Escrow released")
- User Flow: If no crypto, prompt onramp; fund wallet then proceed to escrow payment
- Sandbox: Use Onramp test mode for dev
- Enhancements: Offramp hooks (future fiat cashout); multi-network (Base primary)

## Key Integration Requirements
- Onramp: Coinbase Onramp API keys; SDK from GitHub demos
- Expo: For React Native, notifications, Apple Pay
- Other: As in Phases 1/2

## Security & Compliance
- As previous, plus: Secure wallet creation (no server keys); KYC for onramp if required; PCI for fiat

## Testing Requirements
- As previous, plus: Onramp simulations (sandbox buys), wallet funding to escrow flows

## Deployment
- Replit: Add env vars (add COINBASE_ONRAMP_API_KEY, EXPO_PUSH_TOKEN, BASE_USDC_ADDRESS)
- package.json: Add "expo": "^49.0.0", "@coinbase/onramp-sdk": "^1.0.0", "expo-notifications": "^0.20.0"

---

Generate full code for Phases 1, 2, & 3, including setup instructions for Replit (environment variables, package installations via package.json). Ensure all features are implemented with basic security best practices. Provide sample data and test scripts for an end-to-end alcohol order flow, including onramp crypto purchase, age verification, AI recommendations, escrow crypto payment, tracking, delivery completion (escrow release), tax calculation/logging, simulated monthly remittance, driver activity drop triggering wellness check, digital agreement signing, insurance verification/expiry hold, and NFT minting on milestone.

### Detailed Coinbase Onramp SDK Integration with Base Paymaster Setup in React Native

Based on the official Coinbase Developer Platform (CDP) documentation and demo repositories, below is a comprehensive guide to integrating the Coinbase Onramp SDK (often referred to as "Onramper" in some contexts, but it's Coinbase's Onramp v2) into a React Native app using Expo. This includes setup for embedded wallets, fiat-to-crypto onramp (e.g., buying USDC with Apple Pay/Google Pay), and Base Paymaster for gasless transactions on the Base network. The integration enables users to buy crypto directly in-app and perform gas-sponsored (free) transactions, such as USDC transfers or escrow deposits in your CryptoEats app.

This guide assumes you're building on a React Native + Expo project (as in your CryptoEats setup). It draws from:
- [React Native Quickstart](https://docs.cdp.coinbase.com/embedded-wallets/react-native/quickstart)
- [Onramp Integration](https://docs.cdp.coinbase.com/embedded-wallets/onramp-integration)
- [Paymaster Quickstart](https://docs.cdp.coinbase.com/paymaster/introduction/quickstart)
- Onramp Mobile Demo Repo (high-level structure and features)

I'll provide step-by-step instructions, including installation, configuration, code examples, and usage in your app. Focus is on EVM (Base) support for gasless USDC/EURC/cbBTC transfers via Paymaster.

#### Prerequisites
- Coinbase Developer Platform (CDP) account: Sign up at [portal.cdp.coinbase.com](https://portal.cdp.coinbase.com) and create a project to get your **Project ID** and **API Key**.
- Expo account for push notifications (free tier).
- Test on iOS Simulator (for Apple Pay) or Android Emulator.
- Base Sepolia testnet for development (use CDP Faucet for test funds).
- Environment variables in `.env` (e.g., `CDP_PROJECT_ID`, `CDP_API_KEY_ID`, `CDP_API_KEY_SECRET`).

#### Step 1: Installation and Project Setup
Use `create-cdp-app` to scaffold a React Native app with embedded wallets pre-configured. This sets up Onramp, wallets, and Paymaster basics.

```bash
npx create @coinbase/cdp-app@latest
```

Follow prompts:
- App Name: e.g., `crypto-eats-onramp`
- Template: `React Native with Expo`
- CDP Project ID: Your project ID from CDP Portal
- Account Type: `EVM Smart Accounts` (enables Paymaster/gas sponsorship)

Then:
```bash
cd crypto-eats-onramp
npm install
```

Additional packages for full integration (add to `package.json` via `npm install`):
- `@coinbase/cdp-sdk`: For core CDP features (wallets, Onramp).
- `@coinbase/cdp-react`: For UI components like FundModal.
- `@coinbase/cdp-hooks`: For hooks like useSendUserOperation.
- `expo-notifications`: For real-time push notifications on transactions.
- `ethers`: For contract interactions (e.g., with your escrow/NFT contracts).
- `walletconnect`: For advanced wallet connections (optional if using embedded).

Example `package.json` dependencies snippet:
```json
"dependencies": {
  "@coinbase/cdp-core": "^1.0.0",
  "@coinbase/cdp-hooks": "^1.0.0",
  "@coinbase/cdp-react": "^1.0.0",
  "@coinbase/cdp-sdk": "^1.0.0",
  "expo": "^49.0.0",
  "expo-notifications": "^0.20.0",
  "ethers": "^6.0.0",
  "react-native": "0.72.6",
  "@walletconnect/react-native": "^2.0.0"
}
```

Run the app:
```bash
npm run ios  # or npm run android
```

#### Step 2: Configure Embedded Wallets and Onramp
In CDP Portal:
- Go to **Embedded Wallets > Domains**: Add your app's deep link scheme (e.g., `crypto-eats://oauth-callback`) for OAuth (social login/Apple Pay).
- Go to **Paymaster**: Select **Base Sepolia** (testnet) or **Base Mainnet**, add your contracts (e.g., escrow/NFT addresses) to the allowlist for sponsorship.
- Get your Paymaster URL (contains API keyâ€”keep secure, use proxy or managed mode).

In your app's root (e.g., `app/_layout.tsx` or `App.tsx`):
- Wrap your app with `CDPHooksProvider` for hooks access.
- Use `useEvmAddress` to get the user's wallet address.
- Configure for Base network and smart accounts (enables Paymaster).

Example code in `app/_layout.tsx` (Expo Router entry):
```tsx
import { CDPHooksProvider } from '@coinbase/cdp-hooks';
import { StatusBar } from 'expo-status-bar';
import { View } from 'react-native';
import { Slot } from 'expo-router'; // For routing

export default function Layout() {
  return (
    <CDPHooksProvider
      config={{
        projectId: process.env.CDP_PROJECT_ID, // From .env
        ethereum: {
          createOnLogin: 'smart', // Use smart accounts for Paymaster
        },
        nativeOAuthCallback: 'crypto-eats://oauth-callback', // Deep link for OAuth/Apple Pay
      }}
    >
      <View style={{ flex: 1 }}>
        <StatusBar style="auto" />
        <Slot /> // Renders child routes
      </View>
    </CDPHooksProvider>
  );
}
```

#### Step 3: Implement Onramp (Fiat-to-Crypto Buy Flow)
Use `@coinbase/cdp-react` for the `FundModal` component to handle Onramp UI.

- Server-side: Create API endpoints for buy options and quotes (as in docs). Place in `app/api/onramp/` (Next.js-style, but adapt for your Node/Express backend if not using Next).
- Client-side: Fetch options/quotes, open FundModal on "Buy Crypto" button.

Example backend endpoints (in Express router, e.g., `backend/routes/onramp.js`):
```js
const express = require('express');
const router = express.Router();
const { generateCDPJWT, getCDPCredentials } = require('./cdp-auth'); // Helper from docs
const { convertSnakeToCamelCase } = require('./to-camel-case'); // Helper

// Buy Options
router.get('/buy-options', async (req, res) => {
  try {
    const { country, subdivision, networks } = req.query;
    const queryParams = new URLSearchParams({ country });
    if (subdivision) queryParams.append('subdivision', subdivision);
    if (networks) queryParams.append('networks', networks);

    const jwt = await generateCDPJWT({
      requestMethod: 'GET',
      requestHost: 'api.developer.coinbase.com',
      requestPath: '/onramp/v1/buy/options',
    });

    const response = await fetch(`https://api.developer.coinbase.com/onramp/v1/buy/options?${queryParams.toString()}`, {
      headers: { Authorization: `Bearer ${jwt}` },
    });

    if (!response.ok) throw new Error('Failed to fetch buy options');
    const data = await response.json();
    res.json(convertSnakeToCamelCase(data));
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Buy Quote
router.post('/buy-quote', async (req, res) => {
  try {
    const body = req.body; // { purchaseCurrency, paymentAmount, etc. }
    const jwt = await generateCDPJWT({
      requestMethod: 'POST',
      requestHost: 'api.developer.coinbase.com',
      requestPath: '/onramp/v1/buy/quote',
    });

    const response = await fetch('https://api.developer.coinbase.com/onramp/v1/buy/quote', {
      method: 'POST',
      headers: { Authorization: `Bearer ${jwt}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    if (!response.ok) throw new Error('Failed to create buy quote');
    const data = await response.json();
    res.json(convertSnakeToCamelCase(data));
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

module.exports = router;
```

Client-side "Buy Crypto" component (e.g., in Customer App checkout screen):
```tsx
import { FundModal } from '@coinbase/cdp-react';
import { useEvmAddress } from '@coinbase/cdp-hooks';
import { useState } from 'react';
import { Button } from 'react-native';

export default function BuyCryptoButton({ onSuccess }) {
  const { evmAddress } = useEvmAddress();
  const [isModalOpen, setModalOpen] = useState(false);

  const fetchBuyOptions = async (params) => {
    const response = await fetch(`/api/onramp/buy-options?country=${params.country}&subdivision=${params.subdivision}`);
    return response.json();
  };

  const fetchBuyQuote = async (params) => {
    const response = await fetch('/api/onramp/buy-quote', {
      method: 'POST',
      body: JSON.stringify(params),
    });
    return response.json();
  };

  return (
    <>
      <Button title="Buy Crypto" onPress={() => setModalOpen(true)} />
      {isModalOpen && (
        <FundModal
          isOpen={isModalOpen}
          onClose={() => setModalOpen(false)}
          onSuccess={onSuccess} // e.g., refresh balance
          fetchBuyOptions={fetchBuyOptions}
          fetchBuyQuote={fetchBuyQuote}
          destinationAddress={evmAddress} // User's wallet
          country="US" // From user IP/location
          subdivision="FL" // Miami-Dade example
          paymentMethod="APPLE_PAY" // Prioritize Apple Pay on iOS
          purchaseCurrency="USDC" // Default to USDC on Base
          purchaseNetwork="base" // Base mainnet
        />
      )}
    </>
  );
}
```

#### Step 4: Base Paymaster Setup for Gasless Transactions
Configure Paymaster in CDP Portal (as above). In app, use `useSendUserOperation` hook with `useCdpPaymaster: true` for sponsored (gasless) txns.

Example in Driver App for releasing escrow after delivery:
```tsx
import { useSendUserOperation, useCurrentUser } from '@coinbase/cdp-hooks';
import { encodeFunctionData } from 'viem';
import { Button } from 'react-native';

// Your Escrow ABI snippet (adapt to your contract)
const escrowAbi = [
  {
    name: 'release',
    type: 'function',
    inputs: [{ name: 'orderId', type: 'uint256' }],
    outputs: [],
  },
] as const;

function CompleteDelivery({ orderId }) {
  const { sendUserOperation, status } = useSendUserOperation();
  const { currentUser } = useCurrentUser();

  const handleComplete = async () => {
    const smartAccount = currentUser?.evmSmartAccounts?.[0];
    if (!smartAccount) return;

    await sendUserOperation({
      evmSmartAccount: smartAccount,
      network: 'base', // Base mainnet
      calls: [
        {
          to: '0x7e1868430e86304Aac93a8964c4a1D5C12A76ED5', // Your Escrow contract
          value: 0n,
          data: encodeFunctionData({
            abi: escrowAbi,
            functionName: 'release',
            args: [BigInt(orderId)],
          }),
        },
      ],
      useCdpPaymaster: true, // Sponsor gas via Base Paymaster
    });
  };

  return <Button title="Complete Delivery" onPress={handleComplete} disabled={status === 'pending'} />;
}
```

#### Step 5: Push Notifications Setup
In `app.json` (Expo config):
```json
"plugins": ["expo-notifications"]
```

Configure in app:
```tsx
import * as Notifications from 'expo-notifications';

// Setup in App.tsx or layout
async function setupNotifications() {
  await Notifications.setNotificationHandler({
    handleNotification: async () => ({ shouldShowAlert: true, shouldPlaySound: false, shouldSetBadge: false }),
  });
  const { status } = await Notifications.requestPermissionsAsync();
  if (status !== 'granted') return;
  const token = (await Notifications.getDevicePushTokenAsync()).data;
  // Send token to backend for CDP push (e.g., transaction updates)
}

// Use for Onramp success or tx confirmation
```

#### Step 6: Testing and Debugging
- Use CDP Sandbox mode (set in portal) for test buys without real money.
- Test Onramp: Simulate Apple Pay on iOS Simulator.
- Test Paymaster: Send tx on Base Sepolia; confirm gas is sponsored (tx hash has no fee from user).
- Errors: Handle with try-catch; common: Invalid config, missing keys.

This setup integrates Onramp with Paymaster for a seamless, gasless experience in your app. For full repo clone, use the demo: `git clone https://github.com/coinbase/onramp-v2-mobile-demo.git`. If you need custom adaptations for CryptoEats (e.g., tying onramp to order payment), let me know!