<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>CryptoEats Merchant Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0A0A0F;
      --surface: #14141F;
      --surface-hover: #1A1A2E;
      --border: #1E1E30;
      --accent: #00D4AA;
      --accent-dim: rgba(0, 212, 170, 0.15);
      --text: #E8E8ED;
      --text-secondary: #8888A0;
      --danger: #FF4D6A;
      --warning: #FFB84D;
      --success: #00D4AA;
      --info: #4D9DFF;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .layout {
      display: grid;
      grid-template-columns: 250px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar-brand {
      padding: 0 24px 20px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .sidebar-brand h1 {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .sidebar-brand span {
      font-size: 12px;
      color: var(--text-secondary);
      display: block;
      margin-top: 4px;
    }

    .restaurant-selector {
      padding: 12px 24px 16px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .restaurant-selector label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: block;
      margin-bottom: 6px;
    }

    .restaurant-selector select {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238888A0' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
    }

    .restaurant-selector select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: inherit;
    }

    .nav-item:hover { background: var(--surface-hover); color: var(--text); }
    .nav-item.active { color: var(--accent); background: var(--accent-dim); border-right: 2px solid var(--accent); }

    .nav-icon { font-size: 16px; width: 20px; text-align: center; }

    .sidebar-footer {
      margin-top: auto;
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .main-content {
      padding: 32px;
      overflow-y: auto;
      max-height: 100vh;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .page-header h2 { font-size: 24px; font-weight: 700; }
    .page-header .refresh-info { font-size: 12px; color: var(--text-secondary); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .welcome-banner {
      background: linear-gradient(135deg, rgba(0,212,170,0.15) 0%, rgba(0,212,170,0.05) 100%);
      border: 1px solid rgba(0,212,170,0.2);
      border-radius: 16px;
      padding: 24px 28px;
      margin-bottom: 24px;
    }

    .welcome-banner h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .welcome-banner p { color: var(--text-secondary); font-size: 14px; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      transition: border-color 0.2s;
    }

    .stat-card:hover { border-color: rgba(0,212,170,0.3); }
    .stat-card .label { font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-bottom: 8px; }
    .stat-card .value { font-size: 28px; font-weight: 700; }
    .stat-card .sub { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    .stat-card .value.accent { color: var(--accent); }
    .stat-card .value.warning { color: var(--warning); }
    .stat-card .value.info { color: var(--info); }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    table { width: 100%; border-collapse: collapse; }

    th {
      text-align: left;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 12px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface-hover); }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .badge-success { background: rgba(0,212,170,0.15); color: var(--success); }
    .badge-warning { background: rgba(255,184,77,0.15); color: var(--warning); }
    .badge-danger { background: rgba(255,77,106,0.15); color: var(--danger); }
    .badge-info { background: rgba(77,157,255,0.15); color: var(--info); }
    .badge-accent { background: rgba(0,212,170,0.15); color: var(--accent); }
    .badge-neutral { background: rgba(136,136,160,0.15); color: var(--text-secondary); }

    .filter-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-bar label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      margin-right: 4px;
    }

    .filter-select {
      padding: 6px 28px 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%238888A0' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
    }

    .filter-select:focus { outline: none; border-color: var(--accent); }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .menu-item-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      transition: border-color 0.2s;
    }

    .menu-item-card:hover { border-color: rgba(0,212,170,0.3); }
    .menu-item-card.unavailable { opacity: 0.5; }
    .menu-item-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }

    .menu-item-desc {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .menu-item-price { font-size: 18px; font-weight: 700; color: var(--accent); margin-bottom: 12px; }

    .menu-item-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }

    .menu-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      background: var(--surface-hover);
      color: var(--text-secondary);
    }

    .menu-tag.alcohol { background: rgba(255,77,106,0.15); color: var(--danger); }
    .menu-tag.category { background: rgba(77,157,255,0.15); color: var(--info); }

    .menu-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .availability-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .availability-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .availability-dot.available { background: var(--success); }
    .availability-dot.unavailable { background: var(--danger); }

    .review-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }

    .review-card:hover { border-color: rgba(0,212,170,0.3); }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .review-stars { color: var(--warning); font-size: 16px; letter-spacing: 2px; }
    .review-date { font-size: 12px; color: var(--text-secondary); }
    .review-comment { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px; }

    .review-response {
      background: var(--accent-dim);
      border-left: 3px solid var(--accent);
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
    }

    .review-response .resp-label {
      font-size: 11px;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .review-response .resp-text { font-size: 13px; color: var(--text); line-height: 1.5; }

    .avg-rating-display {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .avg-rating-big {
      font-size: 48px;
      font-weight: 700;
      color: var(--warning);
    }

    .avg-rating-info .stars { color: var(--warning); font-size: 18px; letter-spacing: 2px; margin-bottom: 4px; }
    .avg-rating-info .total-reviews { font-size: 13px; color: var(--text-secondary); }

    .rating-breakdown { display: flex; flex-direction: column; gap: 8px; }

    .rating-row {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }

    .rating-row .star-label { width: 40px; color: var(--text-secondary); flex-shrink: 0; }

    .rating-bar-bg {
      flex: 1;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .rating-bar-fill {
      height: 100%;
      background: var(--warning);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .rating-row .count { width: 30px; text-align: right; color: var(--text-secondary); }

    .chart-container { padding: 20px 0; }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 220px;
      padding: 0 10px;
    }

    .bar-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      height: 100%;
      justify-content: flex-end;
    }

    .bar {
      width: 100%;
      max-width: 50px;
      background: linear-gradient(to top, var(--accent), rgba(0,212,170,0.6));
      border-radius: 4px 4px 0 0;
      transition: height 0.5s ease;
      min-height: 4px;
      position: relative;
    }

    .bar:hover { opacity: 0.85; }
    .bar-label { font-size: 11px; color: var(--text-secondary); }
    .bar-value { font-size: 11px; font-weight: 600; color: var(--text); }

    .popular-items-list { list-style: none; }

    .popular-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      gap: 12px;
    }

    .popular-item:last-child { border-bottom: none; }

    .popular-item .rank {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent-dim);
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      flex-shrink: 0;
    }

    .popular-item .item-info { flex: 1; }
    .popular-item .item-name { font-weight: 600; font-size: 14px; }
    .popular-item .item-orders { font-size: 12px; color: var(--text-secondary); }
    .popular-item .item-revenue { font-size: 13px; font-weight: 600; color: var(--accent); }

    .pie-chart-container {
      display: flex;
      align-items: center;
      gap: 32px;
      flex-wrap: wrap;
    }

    .pie-chart {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .pie-legend { display: flex; flex-direction: column; gap: 8px; }

    .pie-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .pie-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .pie-legend-item .legend-count {
      color: var(--text-secondary);
      font-size: 12px;
      margin-left: auto;
      padding-left: 16px;
    }

    .settings-section { margin-bottom: 28px; }

    .settings-section h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .info-row:last-child { border-bottom: none; }
    .info-row .info-label { color: var(--text-secondary); font-weight: 500; }
    .info-row .info-value { font-weight: 500; text-align: right; }

    .skeleton {
      background: linear-gradient(90deg, var(--surface-hover) 25%, var(--border) 50%, var(--surface-hover) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-card {
      height: 100px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .skeleton-card::after {
      content: '';
      position: absolute;
      inset: 20px;
      background: linear-gradient(90deg, var(--surface-hover) 25%, var(--border) 50%, var(--surface-hover) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 6px;
    }

    .skeleton-row {
      height: 16px;
      margin-bottom: 12px;
    }

    .skeleton-text { height: 14px; width: 60%; }
    .skeleton-text-sm { height: 12px; width: 40%; }

    .live-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      margin-right: 6px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 360px;
    }

    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--success); color: #0A0A0F; }
    .toast.error { background: var(--danger); color: #fff; }
    .toast.info { background: var(--info); color: #fff; }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-secondary);
    }

    .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state h3 { font-size: 18px; color: var(--text); margin-bottom: 8px; }
    .empty-state p { font-size: 14px; }

    .loading-overlay {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px 24px;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar {
        position: fixed;
        left: -260px;
        z-index: 100;
        width: 250px;
        transition: left 0.3s;
      }
      .sidebar.open { left: 0; }
      .main-content { padding: 20px; }
      .mobile-toggle {
        display: flex !important;
        position: fixed;
        top: 16px;
        left: 16px;
        z-index: 101;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 12px;
        color: var(--text);
        cursor: pointer;
        font-size: 18px;
      }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .info-grid { grid-template-columns: 1fr; }
      .menu-grid { grid-template-columns: 1fr; }
      .analytics-split { grid-template-columns: 1fr !important; }
    }

    .mobile-toggle { display: none; }
    .mobile-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }

    .mobile-overlay.show { display: block; }
  </style>
</head>
<body>

  <button class="mobile-toggle" onclick="toggleSidebar()">&#9776;</button>
  <div class="mobile-overlay" id="mobile-overlay" onclick="toggleSidebar()"></div>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-brand">
        <h1>&#9830; CryptoEats</h1>
        <span>Merchant Dashboard</span>
      </div>

      <div class="restaurant-selector">
        <label>Restaurant</label>
        <select id="restaurant-select" onchange="onRestaurantChange()">
          <option value="">Loading restaurants...</option>
        </select>
      </div>

      <nav>
        <button class="nav-item active" onclick="switchTab('overview')">
          <span class="nav-icon">&#9632;</span> Overview
        </button>
        <button class="nav-item" onclick="switchTab('orders')">
          <span class="nav-icon">&#9776;</span> Orders
        </button>
        <button class="nav-item" onclick="switchTab('menu')">
          <span class="nav-icon">&#9733;</span> Menu
        </button>
        <button class="nav-item" onclick="switchTab('reviews')">
          <span class="nav-icon">&#9829;</span> Reviews
        </button>
        <button class="nav-item" onclick="switchTab('analytics')">
          <span class="nav-icon">&#9650;</span> Analytics
        </button>
        <button class="nav-item" onclick="switchTab('settings')">
          <span class="nav-icon">&#9881;</span> Settings
        </button>
      </nav>

      <div class="sidebar-footer">
        <span id="last-refresh">Loading...</span>
      </div>
    </aside>

    <main class="main-content">
      <div id="loading-state" class="loading-overlay">
        <div class="spinner"></div>
        <div style="color:var(--text-secondary);font-size:14px;">Loading dashboard...</div>
      </div>

      <div id="no-restaurant" style="display:none;">
        <div class="empty-state">
          <div class="empty-icon">&#127860;</div>
          <h3>Select a Restaurant</h3>
          <p>Choose a restaurant from the dropdown in the sidebar to view its dashboard.</p>
        </div>
      </div>

      <div id="dashboard-content" style="display:none;">

        <!-- OVERVIEW -->
        <div id="tab-overview" class="tab-content active">
          <div class="welcome-banner">
            <h2 id="welcome-title">Welcome back</h2>
            <p>Here's your restaurant performance overview.</p>
          </div>
          <div class="stats-grid" id="overview-stats"></div>
          <div class="card">
            <div class="card-title">Recent Orders (Last 10)</div>
            <div style="overflow-x:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Address</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody id="recent-orders-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ORDERS -->
        <div id="tab-orders" class="tab-content">
          <div class="page-header">
            <h2><span class="live-dot"></span>Orders</h2>
            <span class="refresh-info" id="orders-refresh-info">Auto-refresh: 30s</span>
          </div>
          <div class="filter-bar">
            <label>Status:</label>
            <select class="filter-select" id="order-status-filter" onchange="renderOrders()">
              <option value="all">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="preparing">Preparing</option>
              <option value="picked_up">Picked Up</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Status</th>
                  <th>Items</th>
                  <th>Total</th>
                  <th>Delivery Address</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="orders-tbody"></tbody>
            </table>
          </div>
          <div id="orders-empty" style="display:none;">
            <div class="empty-state">
              <div class="empty-icon">&#128230;</div>
              <h3>No orders found</h3>
              <p>No orders match the current filter.</p>
            </div>
          </div>
        </div>

        <!-- MENU -->
        <div id="tab-menu" class="tab-content">
          <div class="page-header">
            <h2>Menu Items</h2>
            <span class="refresh-info" id="menu-count"></span>
          </div>
          <div class="menu-grid" id="menu-grid"></div>
          <div id="menu-empty" style="display:none;">
            <div class="empty-state">
              <div class="empty-icon">&#127869;</div>
              <h3>No menu items</h3>
              <p>This restaurant doesn't have any menu items yet.</p>
            </div>
          </div>
        </div>

        <!-- REVIEWS -->
        <div id="tab-reviews" class="tab-content">
          <div class="page-header">
            <h2>Reviews &amp; Ratings</h2>
          </div>
          <div class="card" id="reviews-summary"></div>
          <div id="reviews-list"></div>
          <div id="reviews-empty" style="display:none;">
            <div class="empty-state">
              <div class="empty-icon">&#11088;</div>
              <h3>No reviews yet</h3>
              <p>Customer reviews will appear here.</p>
            </div>
          </div>
        </div>

        <!-- ANALYTICS -->
        <div id="tab-analytics" class="tab-content">
          <div class="page-header">
            <h2>Analytics</h2>
          </div>
          <div class="card">
            <div class="card-title">Daily Revenue (Last 14 Days)</div>
            <div class="chart-container">
              <div class="bar-chart" id="revenue-chart"></div>
            </div>
          </div>
          <div class="analytics-split" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
            <div class="card">
              <div class="card-title">Popular Items (Top 10)</div>
              <ul class="popular-items-list" id="popular-items"></ul>
              <div id="popular-empty" style="display:none;">
                <div class="empty-state" style="padding:24px;">
                  <p>No order data available.</p>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-title">Orders by Status</div>
              <div class="pie-chart-container" id="status-pie"></div>
            </div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div id="tab-settings" class="tab-content">
          <div class="page-header">
            <h2>Restaurant Settings</h2>
          </div>

          <div class="settings-section">
            <h3>Restaurant Information</h3>
            <div class="card">
              <div id="settings-info"></div>
            </div>
          </div>

          <div class="settings-section">
            <h3>Delivery Configuration</h3>
            <div class="card">
              <div id="settings-delivery"></div>
            </div>
          </div>

          <div class="settings-section">
            <h3>Compliance &amp; Licensing</h3>
            <div class="card">
              <div id="settings-compliance"></div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let restaurantsData = [];
    let merchantData = null;
    let selectedRestaurantId = null;
    let refreshInterval = null;

    function formatCurrency(val) {
      const num = parseFloat(val) || 0;
      return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    function formatDateShort(dateStr) {
      if (!dateStr) return '—';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function truncateId(id) {
      if (!id) return '—';
      return id.length > 12 ? id.substring(0, 12) + '…' : id;
    }

    function getStars(rating) {
      const r = Math.round(rating);
      return '★'.repeat(r) + '☆'.repeat(5 - r);
    }

    function getStatusBadgeClass(status) {
      const map = {
        pending: 'badge-warning',
        confirmed: 'badge-info',
        preparing: 'badge-info',
        picked_up: 'badge-accent',
        delivered: 'badge-success',
        cancelled: 'badge-danger',
      };
      return map[status] || 'badge-neutral';
    }

    function formatStatus(status) {
      return (status || '').replace(/_/g, ' ');
    }

    function getItemsCount(items) {
      if (!items || !Array.isArray(items)) return 0;
      return items.reduce((sum, i) => sum + (i.quantity || 1), 0);
    }

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + (type || 'info');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

      const tabEl = document.getElementById('tab-' + tab);
      if (tabEl) tabEl.classList.add('active');

      const navItems = document.querySelectorAll('.nav-item');
      const tabNames = ['overview', 'orders', 'menu', 'reviews', 'analytics', 'settings'];
      const idx = tabNames.indexOf(tab);
      if (idx >= 0 && navItems[idx]) navItems[idx].classList.add('active');

      if (window.innerWidth <= 900) {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('mobile-overlay').classList.remove('show');
      }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('mobile-overlay').classList.toggle('show');
    }

    async function apiFetch(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('API error: ' + res.status);
      return res.json();
    }

    async function loadRestaurants() {
      try {
        restaurantsData = await apiFetch('/api/admin/restaurants');
        const select = document.getElementById('restaurant-select');
        if (!restaurantsData || restaurantsData.length === 0) {
          select.innerHTML = '<option value="">No restaurants available</option>';
          document.getElementById('loading-state').style.display = 'none';
          document.getElementById('no-restaurant').style.display = 'block';
          return;
        }

        select.innerHTML = restaurantsData.map(r =>
          '<option value="' + r.id + '">' + escapeHtml(r.name) + '</option>'
        ).join('');

        selectedRestaurantId = restaurantsData[0].id;
        await loadMerchantData();
      } catch (err) {
        console.error('Failed to load restaurants:', err);
        document.getElementById('loading-state').innerHTML =
          '<div class="empty-state"><div class="empty-icon">&#9888;</div><h3>Connection Error</h3><p>Could not load restaurants. Please refresh the page.</p></div>';
      }
    }

    async function onRestaurantChange() {
      const select = document.getElementById('restaurant-select');
      selectedRestaurantId = select.value;
      if (!selectedRestaurantId) return;
      document.getElementById('dashboard-content').style.display = 'none';
      document.getElementById('loading-state').style.display = 'flex';
      await loadMerchantData();
    }

    async function loadMerchantData() {
      if (!selectedRestaurantId) return;
      try {
        merchantData = await apiFetch('/api/merchant/stats/' + selectedRestaurantId);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-restaurant').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
        renderAll();
        document.getElementById('last-refresh').textContent = 'Updated ' + new Date().toLocaleTimeString();
      } catch (err) {
        console.error('Failed to load merchant data:', err);
        showToast('Failed to load restaurant data', 'error');
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-restaurant').style.display = 'block';
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function renderAll() {
      if (!merchantData) return;
      renderOverview();
      renderOrders();
      renderMenu();
      renderReviews();
      renderAnalytics();
      renderSettings();
    }

    function renderOverview() {
      const o = merchantData.overview;
      const r = merchantData.restaurant;

      document.getElementById('welcome-title').textContent = 'Welcome back, ' + (r.name || 'Restaurant');

      const cards = [
        { label: 'Total Orders', value: o.totalOrders, color: '' },
        { label: "Today's Orders", value: o.todayOrders, color: 'info' },
        { label: 'Total Revenue', value: formatCurrency(o.totalRevenue), color: 'accent' },
        { label: "Today's Revenue", value: formatCurrency(o.todayRevenue), color: 'accent' },
        { label: 'Avg Order Value', value: formatCurrency(o.avgOrderValue), color: 'accent' },
        { label: 'Avg Rating', value: parseFloat(o.avgRating).toFixed(1), color: 'warning', sub: getStars(parseFloat(o.avgRating)) },
        { label: 'Total Reviews', value: o.totalReviews, color: '' },
        { label: 'Menu Items', value: o.menuItemCount, color: '' },
      ];

      document.getElementById('overview-stats').innerHTML = cards.map(c =>
        '<div class="stat-card">' +
          '<div class="label">' + c.label + '</div>' +
          '<div class="value' + (c.color ? ' ' + c.color : '') + '">' + c.value + '</div>' +
          (c.sub ? '<div class="sub" style="color:var(--warning);letter-spacing:2px;">' + c.sub + '</div>' : '') +
        '</div>'
      ).join('');

      const recentOrders = (merchantData.recentOrders || []).slice(0, 10);
      const tbody = document.getElementById('recent-orders-tbody');

      if (recentOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:24px;">No recent orders</td></tr>';
        return;
      }

      tbody.innerHTML = recentOrders.map(order => {
        const itemCount = getItemsCount(order.items);
        return '<tr>' +
          '<td style="font-family:monospace;font-size:12px;color:var(--accent);">' + truncateId(order.id) + '</td>' +
          '<td>' + itemCount + ' item' + (itemCount !== 1 ? 's' : '') + '</td>' +
          '<td style="font-weight:600;">' + formatCurrency(order.total) + '</td>' +
          '<td><span class="badge ' + getStatusBadgeClass(order.status) + '">' + formatStatus(order.status) + '</span></td>' +
          '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escapeHtml(order.deliveryAddress || '—') + '</td>' +
          '<td style="white-space:nowrap;">' + formatDate(order.createdAt) + '</td>' +
        '</tr>';
      }).join('');
    }

    function renderOrders() {
      const filter = document.getElementById('order-status-filter').value;
      let orders = merchantData.recentOrders || [];

      if (filter !== 'all') {
        orders = orders.filter(o => o.status === filter);
      }

      const tbody = document.getElementById('orders-tbody');
      const emptyEl = document.getElementById('orders-empty');

      if (orders.length === 0) {
        tbody.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';
      tbody.innerHTML = orders.map(order => {
        const itemCount = getItemsCount(order.items);
        return '<tr>' +
          '<td style="font-family:monospace;font-size:12px;color:var(--accent);">' + truncateId(order.id) + '</td>' +
          '<td><span class="badge ' + getStatusBadgeClass(order.status) + '">' + formatStatus(order.status) + '</span></td>' +
          '<td>' + itemCount + ' item' + (itemCount !== 1 ? 's' : '') + '</td>' +
          '<td style="font-weight:600;">' + formatCurrency(order.total) + '</td>' +
          '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escapeHtml(order.deliveryAddress || '—') + '</td>' +
          '<td style="white-space:nowrap;">' + formatDate(order.createdAt) + '</td>' +
        '</tr>';
      }).join('');
    }

    function renderMenu() {
      const items = merchantData.menuItems || [];
      const grid = document.getElementById('menu-grid');
      const emptyEl = document.getElementById('menu-empty');

      document.getElementById('menu-count').textContent = items.length + ' items';

      if (items.length === 0) {
        grid.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';
      grid.innerHTML = items.map(item => {
        const isAvailable = item.available !== false;
        const dietaryTags = item.dietaryTags || [];
        const tagsHtml = dietaryTags.map(t => '<span class="menu-tag">' + escapeHtml(t) + '</span>').join('');
        const alcoholHtml = item.isAlcohol ? '<span class="menu-tag alcohol">&#127863; Alcohol</span>' : '';
        const categoryHtml = '<span class="menu-tag category">' + escapeHtml(item.category || 'Other') + '</span>';

        return '<div class="menu-item-card' + (isAvailable ? '' : ' unavailable') + '">' +
          '<div class="menu-item-name">' + escapeHtml(item.name) + '</div>' +
          '<div class="menu-item-desc">' + escapeHtml(item.description || '') + '</div>' +
          '<div class="menu-item-price">' + formatCurrency(item.price) + '</div>' +
          '<div class="menu-item-tags">' + categoryHtml + tagsHtml + alcoholHtml + '</div>' +
          '<div class="menu-item-footer">' +
            '<div class="availability-indicator">' +
              '<span class="availability-dot ' + (isAvailable ? 'available' : 'unavailable') + '"></span>' +
              '<span>' + (isAvailable ? 'Available' : 'Unavailable') + '</span>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    function renderReviews() {
      const reviews = merchantData.reviews || [];
      const summaryEl = document.getElementById('reviews-summary');
      const listEl = document.getElementById('reviews-list');
      const emptyEl = document.getElementById('reviews-empty');

      if (reviews.length === 0) {
        summaryEl.style.display = 'none';
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';
      summaryEl.style.display = 'block';

      const avgRating = parseFloat(merchantData.overview.avgRating) || 0;
      const totalReviews = merchantData.overview.totalReviews || 0;

      const ratingCounts = [0, 0, 0, 0, 0];
      reviews.forEach(r => {
        const rating = r.restaurantRating || 0;
        if (rating >= 1 && rating <= 5) ratingCounts[rating - 1]++;
      });

      const maxCount = Math.max(...ratingCounts, 1);

      let breakdownHtml = '';
      for (let i = 5; i >= 1; i--) {
        const count = ratingCounts[i - 1];
        const pct = (count / maxCount) * 100;
        breakdownHtml += '<div class="rating-row">' +
          '<span class="star-label">' + i + ' ★</span>' +
          '<div class="rating-bar-bg"><div class="rating-bar-fill" style="width:' + pct + '%;"></div></div>' +
          '<span class="count">' + count + '</span>' +
        '</div>';
      }

      summaryEl.innerHTML =
        '<div style="display:flex;gap:40px;flex-wrap:wrap;">' +
          '<div>' +
            '<div class="avg-rating-display">' +
              '<div class="avg-rating-big">' + avgRating.toFixed(1) + '</div>' +
              '<div class="avg-rating-info">' +
                '<div class="stars" style="color:var(--warning);font-size:18px;letter-spacing:2px;">' + getStars(avgRating) + '</div>' +
                '<div class="total-reviews" style="font-size:13px;color:var(--text-secondary);">' + totalReviews + ' review' + (totalReviews !== 1 ? 's' : '') + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div style="flex:1;min-width:250px;">' +
            '<div class="rating-breakdown">' + breakdownHtml + '</div>' +
          '</div>' +
        '</div>';

      listEl.innerHTML = reviews.map(r => {
        const responseHtml = r.restaurantResponse ?
          '<div class="review-response">' +
            '<div class="resp-label">Restaurant Response</div>' +
            '<div class="resp-text">' + escapeHtml(r.restaurantResponse) + '</div>' +
          '</div>' : '';

        return '<div class="review-card">' +
          '<div class="review-header">' +
            '<div>' +
              '<div class="review-stars">' + getStars(r.restaurantRating || 0) + '</div>' +
            '</div>' +
            '<div class="review-date">' + formatDate(r.createdAt) + '</div>' +
          '</div>' +
          '<div class="review-comment">' + escapeHtml(r.comment || 'No comment') + '</div>' +
          responseHtml +
        '</div>';
      }).join('');
    }

    function renderAnalytics() {
      renderRevenueChart();
      renderPopularItems();
      renderStatusPie();
    }

    function renderRevenueChart() {
      const dailyRevenue = merchantData.dailyRevenue || {};
      const chartEl = document.getElementById('revenue-chart');

      const today = new Date();
      const days = [];
      for (let i = 13; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        days.push(d.toISOString().split('T')[0]);
      }

      const values = days.map(d => (dailyRevenue[d] || { revenue: 0 }).revenue);
      const maxVal = Math.max(...values, 1);

      if (values.every(v => v === 0)) {
        chartEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);font-size:14px;">No revenue data for the last 14 days</div>';
        return;
      }

      chartEl.innerHTML = days.map((day, i) => {
        const val = values[i];
        const heightPct = (val / maxVal) * 100;
        const label = new Date(day + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        return '<div class="bar-column">' +
          '<div class="bar-value">' + (val > 0 ? formatCurrency(val) : '') + '</div>' +
          '<div class="bar" style="height:' + Math.max(heightPct, 2) + '%;"></div>' +
          '<div class="bar-label">' + label + '</div>' +
        '</div>';
      }).join('');
    }

    function renderPopularItems() {
      const items = merchantData.popularItems || [];
      const listEl = document.getElementById('popular-items');
      const emptyEl = document.getElementById('popular-empty');

      if (items.length === 0) {
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';
      listEl.innerHTML = items.slice(0, 10).map((item, i) =>
        '<li class="popular-item">' +
          '<span class="rank">' + (i + 1) + '</span>' +
          '<div class="item-info">' +
            '<div class="item-name">' + escapeHtml(item.name) + '</div>' +
            '<div class="item-orders">' + item.count + ' ordered</div>' +
          '</div>' +
          '<span class="item-revenue">' + formatCurrency(item.revenue) + '</span>' +
        '</li>'
      ).join('');
    }

    function renderStatusPie() {
      const ordersByStatus = merchantData.ordersByStatus || {};
      const container = document.getElementById('status-pie');

      const statusColors = {
        pending: '#FFB84D',
        confirmed: '#4D9DFF',
        preparing: '#A855F7',
        picked_up: '#00D4AA',
        delivered: '#10B981',
        cancelled: '#FF4D6A',
      };

      const entries = Object.entries(ordersByStatus);
      const total = entries.reduce((s, [, v]) => s + v, 0);

      if (total === 0) {
        container.innerHTML = '<div style="color:var(--text-secondary);font-size:14px;">No order data available</div>';
        return;
      }

      let conicParts = [];
      let cumulative = 0;
      entries.forEach(([status, count]) => {
        const pct = (count / total) * 100;
        const color = statusColors[status] || '#8888A0';
        conicParts.push(color + ' ' + cumulative + '% ' + (cumulative + pct) + '%');
        cumulative += pct;
      });

      const legendHtml = entries.map(([status, count]) => {
        const color = statusColors[status] || '#8888A0';
        const pct = ((count / total) * 100).toFixed(1);
        return '<div class="pie-legend-item">' +
          '<span class="pie-legend-dot" style="background:' + color + ';"></span>' +
          '<span>' + formatStatus(status) + ' (' + pct + '%)</span>' +
          '<span class="legend-count">' + count + '</span>' +
        '</div>';
      }).join('');

      container.innerHTML =
        '<div class="pie-chart" style="background:conic-gradient(' + conicParts.join(', ') + ');"></div>' +
        '<div class="pie-legend">' + legendHtml + '</div>';
    }

    function renderSettings() {
      const r = merchantData.restaurant;
      if (!r) return;

      const hours = r.operatingHours;
      let hoursDisplay = '—';
      if (hours) {
        if (typeof hours === 'string') {
          hoursDisplay = hours;
        } else if (hours.open && hours.close) {
          const daysStr = (hours.days || []).join(', ');
          hoursDisplay = hours.open + ' – ' + hours.close + (daysStr ? ' (' + daysStr + ')' : '');
        }
      }

      document.getElementById('settings-info').innerHTML =
        '<div class="info-row"><span class="info-label">Restaurant Name</span><span class="info-value">' + escapeHtml(r.name) + '</span></div>' +
        '<div class="info-row"><span class="info-label">Cuisine Type</span><span class="info-value">' + escapeHtml(r.cuisineType || '—') + '</span></div>' +
        '<div class="info-row"><span class="info-label">Address</span><span class="info-value">' + escapeHtml(r.address || '—') + '</span></div>' +
        '<div class="info-row"><span class="info-label">Phone</span><span class="info-value">' + escapeHtml(r.phone || '—') + '</span></div>' +
        '<div class="info-row"><span class="info-label">Operating Hours</span><span class="info-value">' + escapeHtml(hoursDisplay) + '</span></div>';

      document.getElementById('settings-delivery').innerHTML =
        '<div class="info-row"><span class="info-label">Delivery Fee</span><span class="info-value">' + formatCurrency(r.deliveryFee) + '</span></div>' +
        '<div class="info-row"><span class="info-label">Minimum Order</span><span class="info-value">' + formatCurrency(r.minimumOrder) + '</span></div>' +
        '<div class="info-row"><span class="info-label">Estimated Prep Time</span><span class="info-value">' + escapeHtml(r.estimatedPrepTime || '25-35 min') + '</span></div>';

      const approvedBadge = r.isApproved ?
        '<span class="badge badge-success">Approved</span>' :
        '<span class="badge badge-warning">Pending Approval</span>';

      const alcoholBadge = r.alcoholLicense ?
        '<span class="badge badge-success">Licensed</span>' :
        '<span class="badge badge-neutral">Not Licensed</span>';

      document.getElementById('settings-compliance').innerHTML =
        '<div class="info-row"><span class="info-label">Approval Status</span><span class="info-value">' + approvedBadge + '</span></div>' +
        '<div class="info-row"><span class="info-label">Alcohol License</span><span class="info-value">' + alcoholBadge + '</span></div>' +
        '<div class="info-row"><span class="info-label">Restaurant ID</span><span class="info-value" style="font-family:monospace;font-size:12px;">' + escapeHtml(r.id) + '</span></div>' +
        '<div class="info-row"><span class="info-label">Created</span><span class="info-value">' + formatDate(r.createdAt) + '</span></div>';
    }

    async function init() {
      await loadRestaurants();

      refreshInterval = setInterval(async () => {
        if (selectedRestaurantId) {
          try {
            merchantData = await apiFetch('/api/merchant/stats/' + selectedRestaurantId);
            renderAll();
            document.getElementById('last-refresh').textContent = 'Updated ' + new Date().toLocaleTimeString();
          } catch (err) {
            console.error('Auto-refresh failed:', err);
          }
        }
      }, 30000);
    }

    init();
  </script>
</body>
</html>